<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Warens – Admin reservas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    input, select, button { padding: 8px; margin: 4px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #f5f5f5; text-align: left; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .card { border: 1px solid #eee; padding: 12px; margin-top: 16px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Admin – Reservas</h1>

  <div class="card">
    <h3>Autenticación</h3>
    <input id="pwd" type="password" placeholder="ADMIN_PASSWORD">
    <button onclick="saveToken()">Usar</button>
    <a id="csv" target="_blank">Descargar CSV</a>
  </div>

  <div class="card">
    <h3>Abrir/Cerrar cupo</h3>
    <div class="row">
      <input id="ov-date" type="date">
      <select id="ov-slot">
        <option value="A">A (13–15)</option>
        <option value="B">B (15–17)</option>
      </select>
      <select id="ov-open">
        <option value="true">Abrir</option>
        <option value="false">Cerrar</option>
      </select>
      <button onclick="toggle()">Aplicar</button>
    </div>
    <div id="ov-msg"></div>
  </div>

  <div class="card">
    <h3>Reservas</h3>
    <div class="row">
      <label>Desde: <input id="from" type="date"></label>
      <label>Hasta: <input id="to" type="date"></label>
      <button onclick="load()">Cargar</button>
    </div>
    <table id="tbl">
      <thead><tr><th>Fecha</th><th>Slot</th><th>Nombre</th><th>Phone</th><th>Instagram</th><th>Creado</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const API = location.origin;

function tok() { return localStorage.getItem('admin_token') || ''; }
function saveToken(){ localStorage.setItem('admin_token', document.getElementById('pwd').value.trim()); updateCSV(); }
function updateCSV(){ document.getElementById('csv').href = API + '/admin/api/bookings.csv'; document.getElementById('csv').onclick = (e)=>{ e.preventDefault(); window.open(API + '/admin/api/bookings.csv','_blank'); }; }

async function load() {
  const q = [];
  const f = document.getElementById('from').value;
  const t = document.getElementById('to').value;
  if (f) q.push('from='+encodeURIComponent(f));
  if (t) q.push('to='+encodeURIComponent(t));
  const url = API + '/admin/api/bookings' + (q.length?('?'+q.join('&')):'');
  const r = await fetch(url, { headers: { Authorization: 'Bearer ' + tok() }});
  const data = await r.json();
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '';
  if (Array.isArray(data)) {
    for (const row of data) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.date}</td><td>${row.slot}</td><td>${row.full_name}</td><td>${row.phone}</td><td>${row.instagram}</td><td>${new Date(row.created_at).toLocaleString()}</td>`;
      tb.appendChild(tr);
    }
  } else {
    tb.innerHTML = `<tr><td colspan="6">${data.error||'Error'}</td></tr>`;
  }
}

async function toggle() {
  const date = document.getElementById('ov-date').value;
  const slot = document.getElementById('ov-slot').value;
  const is_open = document.getElementById('ov-open').value === 'true';
  const r = await fetch(API + '/admin/api/slot', {
    method: 'POST',
    headers: { 'Content-Type':'application/json', Authorization: 'Bearer ' + tok() },
    body: JSON.stringify({ date, slot, is_open })
  });
  const j = await r.json();
  document.getElementById('ov-msg').textContent = j.ok ? 'Actualizado' : (j.error||'Error');
}
</script>
</body>
</html>
